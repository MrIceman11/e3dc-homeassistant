e3dc_sensors:
  template:
    - sensor:
        #- name: "E3DC External Power"
        #  unique_id: e3dc_external_power
        #  default_entity_id: sensor.e3dc_external_power
        #  unit_of_measurement: "W"
        #  availability: "{{ states('sensor.e3dc_external_power') | is_number }}"
        #  state: >
        #    {{ states('sensor.e3dc_external_power') | float | abs }}
        - name: "E3DC Grid Export Power"
          unique_id: e3dc_grid_export_power
          default_entity_id: sensor.e3dc_grid_export_power
          unit_of_measurement: "W"
          device_class: power
          availability: "{{ states('sensor.e3dc_grid_power') | is_number }}"
          state: >
            {% set val = states('sensor.e3dc_grid_power') | float(0) %}
            {{ (val * -1) if val < 0 else 0 }}
        - name: "E3DC Grid Import Power"
          unique_id: e3dc_grid_import_power
          default_entity_id: sensor.e3dc_grid_import_power
          unit_of_measurement: "W"
          device_class: power
          availability: "{{ states('sensor.e3dc_grid_power') | is_number }}"
          state: >
            {% set val = states('sensor.e3dc_grid_power') | float(0) %}
            {{ val if val > 0 else 0 }}
        - name: "E3DC Battery Charging Power"
          unique_id: e3dc_battery_charge_power
          default_entity_id: sensor.e3dc_battery_charge_power
          unit_of_measurement: "W"
          device_class: power
          availability: "{{ states('sensor.e3dc_battery_power') | is_number }}"
          state: >
            {% set val = states('sensor.e3dc_battery_power') | float(0) %}
            {{ val  if val > 0 else 0 }}
        - name: "E3DC Battery Discharging Power"
          unique_id: e3dc_battery_discharge_power
          default_entity_id: sensor.e3dc_battery_discharge_power
          unit_of_measurement: "W"
          device_class: power
          availability: "{{ states('sensor.e3dc_battery_power') | is_number }}"
          state: >
            {% set val = states('sensor.e3dc_battery_power') | float(0) %}
            {{ (val * -1) if val < 0 else 0 }}
        - name: "E3DC Battery Power inverted"
          unique_id: e3dc_battery_power_inverted
          default_entity_id: sensor.e3dc_battery_power_inverted
          unit_of_measurement: "W"
          device_class: power
          state_class: measurement
          availability: "{{ states('sensor.e3dc_battery_power') | is_number }}"
          state: >
            {% set power = states('sensor.e3dc_battery_power') | float(0) %}
            {{ power * -1 }}
        - name: "E3DC Autarky"
          unique_id: e3dc_autarky
          default_entity_id: sensor.e3dc_autarky
          unit_of_measurement: "%"
          state: >
            {{ (states('sensor.e3dc_autarky_and_consumption') | int(0) / 256) | round(0, 'floor') }}
        - name: "E3DC Own Consumption Ratio"
          unique_id: e3dc_own_consumption_ratio
          default_entity_id: sensor.e3dc_own_consumption_ratio
          unit_of_measurement: "%"
          state: >
            {{ ((states('sensor.e3dc_autarky_and_consumption') | int(0) / 256
                - states('sensor.e3dc_autarky') | int(0)) * 256) | round(0, 'floor') }}
        - name: "E3DC Emergency Power State Text"
          unique_id: e3dc_emergency_power_state_text
          default_entity_id: sensor.e3dc_emergency_power_state_text
          state: >
            {% set eps = states('sensor.e3dc_emergency_power_state') %}
            {% if eps == '0' %}
              nicht unterst端tzt
            {% elif eps == '1' %}
              aktiv
            {% elif eps == '2' %}
              inaktiv
            {% elif eps == '3' %}
              nicht verf端gbar
            {% elif eps == '4' %}
              falsche Position
            {% else %}
              unbekannt
            {% endif %}
        - name: "E3DC SG Ready State Text"
          unique_id: e3dc_sg_ready_state_text
          default_entity_id: sensor.e3dc_sg_ready_state_text
          state: >
            {% set sgrs = states('sensor.e3dc_sg_ready_state') %}
            {% if sgrs == '1' %}
              sperrbetrieb
            {% elif sgrs == '2' %}
              normalbetrieb
            {% elif sgrs == '3' %}
              pv-端berschussbetrieb
            {% elif sgrs == '4' %}
              betrieb f端r abriegelung
            {% else %}
              unbekannt
            {% endif %}
  # Integrations
  sensor:
    - platform: integration
      source: sensor.e3dc_grid_import_power
      name: E3DC Grid Import Energy
      unit_prefix: k
      round: 2
      method: left
      unique_id: e3dc_grid_import_energy
    - platform: integration
      source: sensor.e3dc_grid_export_power
      name: E3DC Grid Export Energy
      unique_id: e3dc_grid_export_energy
      unit_prefix: k
      round: 2
      method: left
    - platform: integration
      source: sensor.e3dc_solar_power
      unique_id: e3dc_solar_energy
      name: E3DC Solar Energy
      unit_prefix: k
      round: 2
      method: left
    - platform: integration
      source: sensor.e3dc_external_power
      name: E3DC External Energy
      unique_id: e3dc_external_energy
      unit_prefix: k
      round: 2
      method: left
    - platform: integration
      source: sensor.e3dc_battery_power
      name: E3DC Builtin Battery Energy
      unique_id: e3dc_builtin_battery_energy
      unit_prefix: k
      round: 2
      method: left
    - platform: integration
      source: sensor.e3dc_battery_charge_power
      name: E3DC Battery Charge Energy
      unique_id: e3dc_battery_charge_energy
      unit_prefix: k
      round: 2
      method: left
    - platform: integration
      source: sensor.e3dc_battery_discharge_power
      name: E3DC Battery Discharge Energy
      unique_id: e3dc_battery_discharge_energy
      unit_prefix: k
      round: 2
      method: left
    - platform: integration
      source: sensor.e3dc_wallbox_power
      name: E3DC Wallbox Energy
      unit_prefix: k
      round: 2
      method: left
    - platform: integration
      source: sensor.e3dc_wallbox_solar_power
      name: E3DC Wallbox Solar Energy
      unit_prefix: k
      round: 2
      method: left
